<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<body>

<div id="page-content">
    <div class="panel">
        <div class="panel-heading">
            <h3 class="panel-title">菜单管理</h3>
        </div>
        <div class="panel-body">

            <div class="row">
                <button type="button" id="btn_add_menu" class="btn btn-primary btn-sm">新建菜单</button>
                <button type="button" id="init_menu_data" class="btn btn-info btn-sm pull-right">初始化菜单数据</button>
                <button type="button" id="init_menu_test" class="btn btn-info btn-sm pull-right">我的测试</button>
            </div>

            <div class="table-jqgrid">
                <table id="menu_table"></table>
                <div id="menu_page"></div>
            </div>

        </div>
    </div>
</div>

</body>

<script th:inline="javascript">

    $(function(){
        init_grid_menu();
    });

    function init_grid_menu(){
        __init_jqgrid('menu_table', 'menu_page', '/main/menu/list',
            ["菜单名称","类型","图标","连接地址","状态","操作","id"],
            [
                {name:'name', index:'name', width:100, search:true, sortable:false, searchoptions: {sopt: ['cn']}},
                {name:'menuType', index:'menuType', width:100, search:true, sortable:false, searchoptions: {sopt: ['cn']}},
                {name:'iconCode', index:'iconCode', width:30, search:true, sortable:false, searchoptions: {sopt: ['cn']}, formatter : menuIconFormat},
                {name:'url', index:'url', width:100, search:true, sortable:false, searchoptions: {sopt: ['cn']}},
                {name:'visible', index:'visible', width:100, search:true, sortable:false, formatter : menuVisibleFormat},
                {name:'act', width:100, sortable:false, formatter : menuActFormat},
                {name:'id',index:'id',search:false,hidden:true}
            ],
            false,
            {
                rowNum : "-1",
                treeGrid : true,
                treeGridModel : "adjacency",
                ExpandColumn : "name",
                ExpandColClick : true,
                pager : false,
                rownumbers : false,
                treeReader : {
                    level_field: "level",
                    parent_id_field: "parent",
                    leaf_field: "isLeaf",
                    expanded_field: "expanded"
                }
            }
        );
    }

    function menuActFormat(cellvalue, options, rowObject){
        var id = rowObject.id;
        cellvalue = '<button class="btn btn-primary btn-sm" onclick="fn_menu_addOrUpdate(\'\',\'' + id + '\');"> 添加</button> ';
        cellvalue += '<button class="btn btn-primary btn-sm" onclick="fn_menu_addOrUpdate(\'' + id + '\',\'\');"> 编辑</button> ';
        cellvalue += '<button class="btn btn-danger btn-sm" onclick="fn_menu_delete(\'' + id + '\');"> 删除</button> ';
        return cellvalue;
    }

    function menuIconFormat(cellvalue, options, rowObject){
        var iconCode = rowObject.iconCode;
        cellvalue = '<i class="'+iconCode+'"></i> ';
        return cellvalue;
    }

    function menuVisibleFormat(cellvalue, options, rowObject){
        var visible = rowObject.visible == "1" ? "" : "checked";
        var id = rowObject.id;
        var sw = '<input id="switch-'+id+'" class="toggle-switch" type="checkbox" '+visible+'><label for="switch-'+id+'" onclick="fn_menu_visible_change(\''+id+'\')"></label>';
        return sw;
    }

    function fn_menu_addOrUpdate(keyId, parentId){
        __layX_html_save(keyId ? keyId : "create", "菜单", "/main/menu/input?keyId="+keyId+"&parentId="+parentId, function(id, button, event){
            var callback = function(data){
                if(data && data.state === 1){
                    __layX_close(id);
                    __reflash_jqgrid("menu_table");
                }
            };
            fn_menu_save(callback);
        })
    }

    //添加菜单
    $("#btn_add_menu").on("click", function(){
        fn_menu_addOrUpdate("","");
    });

    function fn_menu_delete(id){
        __confirm_dialog("","确定要删除吗？",function(){
            __ajax_post("/main/menu/delete", {keyId : id}, function(data){
                __toastr(data);
                if(data && data.state === 1){
                    $("#menu_table").setGridParam({datatype:'json', postData: {}}).trigger('reloadGrid');
                }
            })
        })
    }

    function fn_menu_visible_change(id){
        var visible = 0;
        if($("#switch-"+id).get(0).checked){
            //关闭
            visible = 1;
        }else{
            //打开
        }
        __ajax_post("/main/menu/visibleChange", {keyId : id, visible : visible}, function(data){
            __toastr(data);
        })
    }

    //初始化菜单数据
    $("#init_menu_data").on("click", function(){
        __ajax_post("/main/menu/initMenuData", {}, function(data){
            __toastr(data);
        })
    });

    $("#init_menu_test").on("click", function(){
        __ajax_get("/main/menu/myTest", {}, function(data){
            __toastr(data);
        })
    });

</script>

</html>